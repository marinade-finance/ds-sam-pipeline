name: Evaluate Auction

on:
  workflow_dispatch:
    inputs:
      epoch:
        description: 'Current epoch'
        required: true
        type: number
      slot:
        description: 'Current slot in epoch'
        required: true
        type: number

jobs:
  auction:
    name: Run the auction
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4
        with:
          ref: testing
      - name: Checkout DS SAM
        uses: actions/checkout@v4
        with:
          repository: marinade-finance/ds-sam
          fetch-depth: 10
          ref: init
#          token: ${{ secrets.DS_SAM_ACCESS_TOKEN }}
          path: ds-sam
      - name: Setup NodeJS
        uses: actions/setup-node@v4
        with:
          node-version: 18
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
      - name: Run the auction and prepare results
        run: |
          run_id="${{ inputs.epoch }}.${{ inputs.slot }}"
          mkdir auctions/$run_id

          inputs_dir="$PWD/auctions/$run_id/inputs"
          results_dir="$PWD/auctions/$run_id/results"
          mkdir "$inputs_dir"
          mkdir "$results_dir"
          cp auction-config.json "$inputs_dir/config.json"

          cd ds-sam
          pnpm i --frozen-lockfile
          cd packages/ds-sam-sdk
          pnpm build
          cd ../..
          echo "Running auction: $run_id"
          pnpm run cli -- auction -c "$inputs_dir/config.json" --inputs-source APIS --cache-inputs --cache-dir-path "$inputs_dir" -o "$results_dir" > /dev/null
          cd ..
          git status
          git diff
