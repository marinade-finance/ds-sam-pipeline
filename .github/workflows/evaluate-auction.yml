name: Evaluate Auction

on:
  workflow_dispatch:
    inputs:
      epoch:
        description: 'Current epoch'
        required: true
        type: number
      slot:
        description: 'Current slot in epoch'
        required: true
        type: number

jobs:
  auction:
    name: Run the auction
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4
        with:
          ref: testing
      - name: Checkout DS SAM
        uses: actions/checkout@v4
        with:
          repository: marinade-finance/ds-sam
          fetch-depth: 10
          ref: init
#          token: ${{ secrets.DS_SAM_ACCESS_TOKEN }}
          path: ds-sam
      - name: Setup NodeJS
        uses: actions/setup-node@v4
        with:
          node-version: 18
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
      - name: Run the auction and prepare results
        run: |
          run_id="${{ inputs.epoch }}.${{ inputs.slot }}"
          echo "run_id=$run_id" >> $GITHUB_ENV
          mkdir auctions/$run_id

          inputs_dir="$PWD/auctions/$run_id/inputs"
          results_dir="$PWD/auctions/$run_id/results"
          mkdir "$inputs_dir"
          mkdir "$results_dir"
          cp auction-config.json "$inputs_dir/config.json"

          cd ds-sam
          pnpm i --frozen-lockfile
          cd packages/ds-sam-sdk
          pnpm build
          cd ../..
          echo "Running auction: $run_id"
          pnpm run cli -- auction -c "$inputs_dir/config.json" --inputs-source APIS --cache-inputs --cache-dir-path "$inputs_dir" -o "$results_dir" > /dev/null
          cd ..
      - name: Create a PR
        run: |
          run_id="${{ env.run_id }}"
          branch_name="auction/$run_id"

          git status
          git diff
          git config --global user.name 'Autonomous Auction Pipeline'
          git config --global user.email 'bot@noreply.marinade.finance'
          git checkout -b "$branch_name"
          git add auctions
          git status
          git diff

#          [[ -n "$(git status --porcelain)" ]] && git commit -m "scoring run $scoring_id" && git push -u origin "$scoring_branch" || echo "No changes to be committed"
#
#          pr_url=$(gh pr create -B master -H "$scoring_branch" --title "Publish V2 Scoring Results ($scoring_id)" --body-file "${{ env.scoring_path }}/summary.md")
#          echo "pr_url=$pr_url" >> $GITHUB_ENV
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
